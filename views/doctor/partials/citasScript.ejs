<script>
/* Referencia: https://github.com/todo-list-app/todo-list-app.github.io/blob/e35d8a23a934f74b7e47cf07b3e8814930970b37/todo.js#L522*/
main();

function main(){
  let titleInput,
      dateTimeInput,
      todoList = [],
      citasList = [];
  var calendar;
  getElement();
  addListeners();
  initCalendar();
  load();
    console.log(citasList);
  function getElement(){
    titleInput = document.getElementById("titleInput");
    dateTimeInput = document.getElementById("dateTimeInput");
    addButton = document.getElementById("addBtn");
  }

  function addListeners() {
    addButton.addEventListener("click", addEntry, false);
  }

  function addEntry(event){
    let titleValue = titleInput.value;
    titleInput.value = "";
    let dateValue = dateTimeInput.value;
    dateTimeInput.value = "";

    let obj = {
        todo: titleValue,
        date: dateValue,
        done: false,
    };

    todoList.push(obj);
    console.log(todoList);
    save();
  }

  function load() {
    let retrieved = localStorage.getItem("todoList");
    todoList = JSON.parse(retrieved);
    //console.log(typeof todoList)
    
    if(citasList.length > 0){
        todoList.push.apply(todoList, citasList);
    }
    
    console.log(todoList);
    if (todoList == null)
      todoList = [];

    todoList.map(obj => {
        addEvent({
            title: 'Cita Medica - '+ obj.todo,
            start: obj.date,
        });
    });

    if(citasList != []){
        citasList= [];
    }
  }

  function save() {
    let stringified = JSON.stringify(todoList);
    localStorage.setItem("todoList", stringified);
  }
  
  function initCalendar(){
    var calendarE1 = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarE1,{
      timeZone: 'local',
      themeSystem: 'bootstrap',
      dayMaxEvents: true, // allow "more" link when too many events
      locales: ['idLocale'],
      editable: true,
      selectable: true,
      headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listMonth'
      },
      eventClick: function (info) {
        toEditItem(info.event);
      },
      eventDrop: function (info) {
        calendarEventDragged(info.event);
      },
      events: [], // [{},{}], Agregar Json de eventos
    });
    calendar.render();
  }
  function addEvent(event) {
        calendar.addEvent( event );
    }

  function toEditItem(event) {
    showEditModalBox();

    let id;

    if (event.target) // mouse event
      id = event.target.dataset.id;
    else // calendar event
      id = event.id;

    preFillEditForm(id);
  }
  function preFillEditForm(id) {
    let result = todoList.find(todoObj => todoObj.id == id);
    let { todo, category, date, time } = result;

    document.getElementById("todo-edit-todo").value = todo;
    document.getElementById("todo-edit-category").value = category;
    document.getElementById("todo-edit-date").value = date;
    document.getElementById("todo-edit-time").value = time;

    changeBtn.dataset.id = id;
  }
  function calendarEventDragged(event) {
    let dateObj = new Date(event.start);
    let year = dateObj.getFullYear();
    let month = dateObj.getMonth() + 1;
    let date = dateObj.getDate();

    let paddedMonth = month.toString();
    if (paddedMonth.length < 2) {
      paddedMonth = "0" + paddedMonth;
    }

    let paddedDate = date.toString();
    if (paddedDate.length < 2) {
      paddedDate = "0" + paddedDate;
    }

    let toStoreDate = `${year}-${paddedMonth}-${paddedDate}`;
    console.log(toStoreDate);

    todoList.forEach(todoObj => {
      if (todoObj.id == id) {
        todoObj.date = toStoreDate;
      }
    });

    save();

  }

}
</script>