<script type="text/javascript">
/* Referencia: https://github.com/todo-list-app/todo-list-app.github.io/blob/e35d8a23a934f74b7e47cf07b3e8814930970b37/todo.js#L522*/

var citasList = JSON.parse(document.getElementById("citasList").innerText);
console.log(citasList);

var pacientes = JSON.parse(document.getElementById("pacientes").innerText);
console.log(pacientes);

var pacienteSelect = document.getElementById("pacienteSelect");
for (obj of pacientes) {
  pacienteSelect.innerHTML += `<option value=${obj.dni}>${obj.nombre}</option>`; 
}
dniDValue = document.getElementById("dnid").value;
console.log(dniDValue);
main();


function main(){
  let titleInput,
      dateTimeInput,
      todoList = [];
      
  var calendar;
  getElement();
  addListeners();
  initCalendar();
  load();

  function getElement(){
    titleInput = document.getElementById("titleInput");
    dateTimeInput = document.getElementById("dateTimeInput");
    addButton = document.getElementById("addBtn");
  }

  function addListeners() {
    addButton.addEventListener("click", addEntry, false);
  }

  function addEntry(event){
    let titleValue = titleInput.value;
    titleInput.value = "";
    let dateValue = dateTimeInput.value;
    dateTimeInput.value = "";

    let obj = {
        todo: titleValue,
        date: dateValue,
        done: false,
    };

    todoList.push(obj);
    console.log(todoList);
    save();
    addEvent({
            title: 'Cita Medica - '+ obj.todo,
            start: obj.date,
        });
  }

  function load() {
    let retrieved = localStorage.getItem("todoList");
    todoList = JSON.parse(retrieved);
    //console.log(typeof todoList)
    
    if (todoList == null)
      todoList = [];

    if(citasList.length > 0){
        todoList.push.apply(todoList, citasList);
    }
    
    console.log(todoList);
    
    todoList.map(obj => {
        addEvent({
            title: 'Cita Medica - '+ obj.todo,
            start: obj.date,
            paciente: obj.todo,
            dateTime: obj.date,
            dnid: dniDValue,
        });
    });
    if(citasList != []){
        citasList= [];
    }
  }

  function save() {
    let stringified = JSON.stringify(todoList);
    localStorage.setItem("todoList", stringified);
  }
  
  function initCalendar(){
    var calendarE1 = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarE1,{
      timeZone: 'local',
      themeSystem: 'bootstrap',
      dayMaxEvents: true, // allow "more" link when too many events
      locales: ['idLocale'],
      editable: true,
      selectable: true,
      headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listMonth'
      },
      eventClick: function (info) {
        toDeleteItem(info.event);
        //alert('Event: ' + info.event.title);
      },
      events: [], // [{},{}], Agregar Json de eventos
    });
    calendar.render();
  }
  function addEvent(event) {
        calendar.addEvent( event );
    }
  function toDeleteItem (event){
    let dniDoctor = event._def.extendedProps.dnid;
    let nomPaciente = event._def.extendedProps.paciente;
    let dateTime = event._def.extendedProps.dateTime;
    let dniPaciente;
    pacientes.map(obj =>{
      if(obj.nombre == nomPaciente)
        dniPaciente = obj.dni;
    });
    console.log(dniPaciente);
    document.innerHTML = `
    <form class="d-none" name="eliminarcita" action="./deleteCita" method="POST">
      <input type="text" class="d-none" name="pacienteDni" value=${dniPaciente}>
      <input type="datetime-local" class="d-none" name="dateTime" value=${dateTime}>
      <input type="text" id="dnid" class="d-none" name="dnid" value=${dniDoctor}>
    </form>
    `;
    Swal.fire({
      title: "¿Deseas eliminar la cita?",
      text: `Se eliminara la cita del paciente ${nomPaciente} programada para la fecha ${dateTime}`,
      type: "warning",
      showCancelButton: true,
      confirmButtonClass: "btn-danger",
      confirmButtonText: "Sí, Eliminar cita!",
      closeOnConfirm: false
    }).then((result) => {  
    /* Read more about isConfirmed, isDenied below */  
      if (result.isConfirmed) {    
        document.eliminarcita.submit();
        Swal.fire("Eliminado!", "La cita fue eliminada.", "success");
      } else if (result.isDenied) {    
        Swal.fire('Changes are not saved', '', 'info')  
      }
    });
  }
  
}
</script>